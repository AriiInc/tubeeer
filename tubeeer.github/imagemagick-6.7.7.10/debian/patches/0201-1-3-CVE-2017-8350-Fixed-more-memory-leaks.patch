From 8c6b67e24abf8126b822eeda3c4ab251dd264950 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Thu, 27 Apr 2017 12:06:41 +0200
Subject: [PATCH] [1/3] CVE-2017-8350 Fixed more memory leaks.

(cherry picked from commit 8b7af6e1e7163d62fc98add772da73b2f88b31d7)

origin: https://github.com/ImageMagick/ImageMagick/commit/8b7af6e1e7163d62fc98add772da73b2f88b31d7
bug: https://github.com/ImageMagick/ImageMagick/issues/447
bug-debian: https://bugs.debian.org/862587
---
 coders/png.c | 17 ++++++++++++-----
 1 file changed, 12 insertions(+), 5 deletions(-)

Index: imagemagick-6.7.7.10/coders/png.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/png.c	2017-05-26 09:16:54.632926720 -0400
+++ imagemagick-6.7.7.10/coders/png.c	2017-05-26 09:16:54.632926720 -0400
@@ -5515,10 +5515,14 @@ static Image *ReadOneMNGImage(MngInfo* m
                         offset=SeekBlob(image,mng_info->loop_jump[loop_level],
                           SEEK_SET);
 
-                        if (offset < 0)
-                          ThrowReaderException(CorruptImageError,
-                            "ImproperImageHeader");
-                      }
+                            if (offset < 0)
+                              {
+                                chunk=(unsigned char *) RelinquishMagickMemory(
+                                  chunk);
+                                ThrowReaderException(CorruptImageError,
+                                  "ImproperImageHeader");
+                              }
+                          }
 
                     else
                       {
@@ -5832,7 +5836,10 @@ static Image *ReadOneMNGImage(MngInfo* m
           }
 #if defined(MNG_INSERT_LAYERS)
         if (length < 8)
-          ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+          {
+            chunk=(unsigned char *) RelinquishMagickMemory(chunk);
+            ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+          }
 
         image_width=(size_t) mng_get_long(p);
         image_height=(size_t) mng_get_long(&p[4]);
