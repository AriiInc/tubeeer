From 8d85b7b07a332f25715242e12bddc000a692a253 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Tue, 2 May 2017 08:42:38 +0200
Subject: [PATCH] CVE-2017-9407: the ReadPALMImage function in palm.c allows
 attackers to cause a denial of service (memory leak) via a crafted file.

Fixed memory leak reported in #459.

origin: https://github.com/ImageMagick/ImageMagick/commit/7851278ed92bcdef72132ceadee9256c9d98acf1
bug-debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=864089
bug: https://github.com/ImageMagick/ImageMagick/issues/459

(cherry picked from commit 7851278ed92bcdef72132ceadee9256c9d98acf1)
---
 coders/palm.c | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

Index: imagemagick-6.7.7.10/coders/palm.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/palm.c	2017-07-21 10:00:54.693293332 -0400
+++ imagemagick-6.7.7.10/coders/palm.c	2017-07-21 10:00:54.693293332 -0400
@@ -478,7 +478,12 @@ static Image *ReadPALMImage(const ImageI
       if (bits_per_pixel == 16)
         {
           if (image->columns > (2*bytes_per_row))
-            ThrowReaderException(CorruptImageError,"CorruptImage");
+            {
+              one_row=(unsigned char *) RelinquishMagickMemory(one_row);
+              if (compressionType == PALM_COMPRESSION_SCANLINE)
+                lastrow=(unsigned char *) RelinquishMagickMemory(lastrow);
+              ThrowReaderException(CorruptImageError,"CorruptImage");
+            }
           for (x=0; x < (ssize_t) image->columns; x++)
           {
             color16=(*ptr++ << 8);
@@ -496,7 +501,12 @@ static Image *ReadPALMImage(const ImageI
           for (x=0; x < (ssize_t) image->columns; x++)
           {
             if ((size_t) (ptr-one_row) >= bytes_per_row)
-              ThrowReaderException(CorruptImageError,"CorruptImage");
+              {
+                one_row=(unsigned char *) RelinquishMagickMemory(one_row);
+                if (compressionType == PALM_COMPRESSION_SCANLINE)
+                  lastrow=(unsigned char *) RelinquishMagickMemory(lastrow);
+                ThrowReaderException(CorruptImageError,"CorruptImage");
+              }
             index=(IndexPacket) (mask-(((*ptr) & (mask << bit)) >> bit));
             SetPixelIndex(indexes+x,index);
             SetPixelRGBO(q,image->colormap+(ssize_t) index);
