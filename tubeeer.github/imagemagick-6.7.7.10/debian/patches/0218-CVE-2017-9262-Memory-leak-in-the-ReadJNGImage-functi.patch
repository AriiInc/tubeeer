From 44cf601964f649f3e8a28df1cff5b5065b4f9470 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Sun, 7 May 2017 12:11:52 +0200
Subject: [PATCH] CVE-2017-9262: Memory leak in the ReadJNGImage function

In ImageMagick, the ReadJNGImage function in coders/png.c
allows attackers to cause a denial of service (memory leak) via a
crafted file.

bug-debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=863834
bug: https://github.com/ImageMagick/ImageMagick/issues/475
origin: https://github.com/ImageMagick/ImageMagick/commit/4649578df8dcbfb2b08d8623d52486dc124da3a8
---
 coders/png.c | 21 +++++++++++++++++----
 1 file changed, 17 insertions(+), 4 deletions(-)

Index: imagemagick-6.7.7.10/coders/png.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/png.c	2017-07-21 10:00:47.505292997 -0400
+++ imagemagick-6.7.7.10/coders/png.c	2017-07-21 10:00:47.501292997 -0400
@@ -4038,7 +4038,10 @@ static Image *ReadOneJNGImage(MngInfo *m
           exception);
 
         if (status == MagickFalse)
-          return(DestroyImageList(image));
+          {
+            color_image=DestroyImage(color_image);
+            return(DestroyImageList(image));
+          }
 
         if ((image_info->ping == MagickFalse) && (jng_color_type >= 12))
           {
@@ -4046,14 +4049,19 @@ static Image *ReadOneJNGImage(MngInfo *m
               AcquireMagickMemory(sizeof(ImageInfo));
 
             if (alpha_image_info == (ImageInfo *) NULL)
-              ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
+              {
+                color_image=DestroyImage(color_image);
+                ThrowReaderException(ResourceLimitError,
+                  "MemoryAllocationFailed");
+              }
 
             GetImageInfo(alpha_image_info);
             alpha_image=AcquireImage(alpha_image_info);
 
             if (alpha_image == (Image *) NULL)
               {
-                alpha_image=DestroyImage(alpha_image);
+                alpha_image_info=DestroyImageInfo(alpha_image_info);
+                color_image=DestroyImage(color_image);
                 ThrowReaderException(ResourceLimitError,
                   "MemoryAllocationFailed");
               }
@@ -4067,7 +4075,12 @@ static Image *ReadOneJNGImage(MngInfo *m
               exception);
 
             if (status == MagickFalse)
-              return(DestroyImageList(image));
+              {
+                alpha_image=DestroyImage(alpha_image);
+                alpha_image_info=DestroyImageInfo(alpha_image_info);
+                color_image=DestroyImage(color_image);
+                return(DestroyImageList(image));
+              }
 
             if (jng_alpha_compression_method == 0)
               {
