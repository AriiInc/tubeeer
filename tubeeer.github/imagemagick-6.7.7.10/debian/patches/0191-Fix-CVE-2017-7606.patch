From 93759ce769aad0d30fcca1d28b8762af46e9ed49 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Fri, 31 Mar 2017 15:23:42 -0400
Subject: [PATCH] Fix CVE-2017-7606

coders/rle.c in ImageMagick 7.0.5-4 has an "outside the range of representable values of type unsigned char" undefined behavior issue,
which might allow remote attackers to cause a denial of service (application crash) or possibly have unspecified other impact via crafted file

bug: https://github.com/ImageMagick/ImageMagick/issues/415
origin: https://github.com/ImageMagick/ImageMagick/commit/b2b0aa6bb0d110f8560fe2091671a27d78877f22
bug-gentoo: https://blogs.gentoo.org/ago/2017/04/02/imagemagick-undefined-behavior-in-codersrle-c/
bug-debian: https://bugs.debian.org/859771
bash: o : commande introuvable
Forwarded: https://github.com/ImageMagick/ImageMagick/issues/415
---
 coders/rle.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: imagemagick-6.7.7.10/coders/rle.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/rle.c	2017-05-26 09:16:00.360235445 -0400
+++ imagemagick-6.7.7.10/coders/rle.c	2017-05-26 09:16:00.356235394 -0400
@@ -278,7 +278,8 @@ static Image *ReadRLEImage(const ImageIn
         p=colormap;
         for (i=0; i < (ssize_t) number_colormaps; i++)
           for (x=0; x < (ssize_t) map_length; x++)
-            *p++=(unsigned char) ScaleShortToQuantum(ReadBlobLSBShort(image));
+            *p++=(unsigned char) ScaleQuantumToChar(ScaleShortToQuantum(
+              ReadBlobLSBShort(image)));
       }
     if ((flags & 0x08) != 0)
       {
