From 9b6ee902a435996dd3de72720b95f3da980f34f4 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Wed, 26 Apr 2017 17:25:09 -0400
Subject: [PATCH] CVE-2017-8354

the ReadBMPImage function in bmp.c allows attackers to cause a denial of service (memory leak) via a crafted file.

bug: https://github.com/ImageMagick/ImageMagick/issues/451
bug-debian: https://bugs.debian.org/862633
origin: https://github.com/ImageMagick/ImageMagick/commit/cc8bafff80b7a87288e49defc50c3d3c58ff680f
---
 coders/bmp.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

Index: imagemagick-6.7.7.10/coders/bmp.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/bmp.c	2017-05-26 09:17:20.037250297 -0400
+++ imagemagick-6.7.7.10/coders/bmp.c	2017-05-26 09:17:20.033250246 -0400
@@ -881,10 +881,17 @@ static Image *ReadBMPImage(const ImageIn
           packet_size=4;
         offset=SeekBlob(image,start_position+14+bmp_info.size,SEEK_SET);
         if (offset < 0)
-          ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+          {
+            bmp_colormap=(unsigned char *) RelinquishMagickMemory(bmp_colormap);
+            ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+          }
         count=ReadBlob(image,packet_size*image->colors,bmp_colormap);
         if (count != (ssize_t) (packet_size*image->colors))
-          ThrowReaderException(CorruptImageError,"InsufficientImageDataInFile");
+          {
+            bmp_colormap=(unsigned char *) RelinquishMagickMemory(bmp_colormap);
+            ThrowReaderException(CorruptImageError,
+              "InsufficientImageDataInFile");
+          }
         p=bmp_colormap;
         for (i=0; i < (ssize_t) image->colors; i++)
         {
