From 743ce92d6cacaaf0f186d51c4618abb92d2414e0 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Thu, 27 Apr 2017 11:29:45 +0200
Subject: [PATCH] [1/2] Prepare fix for CVE-2017-8345

Refactored MngInfoFreeStruct in order to apply check only once

bug: https://github.com/ImageMagick/ImageMagick/issues/442
origin: https://github.com/ImageMagick/ImageMagick/commit/8919f333923ad144068fd028d274ca640750e9e6
bug-debian: https://bugs.debian.org/862573
---
 coders/png.c | 81 ++++++++++++++++++++++--------------------------------------
 1 file changed, 30 insertions(+), 51 deletions(-)

Index: imagemagick-6.7.7.10/coders/png.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/png.c	2017-05-26 09:16:23.404528962 -0400
+++ imagemagick-6.7.7.10/coders/png.c	2017-05-26 09:16:23.400528911 -0400
@@ -1625,24 +1625,22 @@ static void MngInfoDiscardObject(MngInfo
     }
 }
 
-static void MngInfoFreeStruct(MngInfo *mng_info,
-    MagickBooleanType *have_mng_structure)
+static MngInfo *MngInfoFreeStruct(MngInfo *mng_info)
 {
-  if (*have_mng_structure != MagickFalse && (mng_info != (MngInfo *) NULL))
-    {
-      register ssize_t
-        i;
+  register ssize_t
+    i;
+
+  if (mng_info == (MngInfo *) NULL)
+    return((MngInfo *) NULL);
 
-      for (i=1; i < MNG_MAX_OBJECTS; i++)
-        MngInfoDiscardObject(mng_info,i);
+  for (i=1; i < MNG_MAX_OBJECTS; i++)
+    MngInfoDiscardObject(mng_info,i);
 
-      if (mng_info->global_plte != (png_colorp) NULL)
-        mng_info->global_plte=(png_colorp)
-          RelinquishMagickMemory(mng_info->global_plte);
+  if (mng_info->global_plte != (png_colorp) NULL)
+    mng_info->global_plte=(png_colorp)
+      RelinquishMagickMemory(mng_info->global_plte);
 
-      mng_info=(MngInfo *) RelinquishMagickMemory(mng_info);
-      *have_mng_structure=MagickFalse;
-    }
+  return((MngInfo *) RelinquishMagickMemory(mng_info));
 }
 
 static MngBox mng_minimum_box(MngBox box1,MngBox box2)
@@ -3638,7 +3636,6 @@ static Image *ReadPNGImage(const ImageIn
     *previous;
 
   MagickBooleanType
-    have_mng_structure,
     logging,
     status;
 
@@ -3682,7 +3679,6 @@ static Image *ReadPNGImage(const ImageIn
   /*
     Allocate a MngInfo structure.
   */
-  have_mng_structure=MagickFalse;
   mng_info=(MngInfo *) AcquireMagickMemory(sizeof(MngInfo));
 
   if (mng_info == (MngInfo *) NULL)
@@ -3693,11 +3689,10 @@ static Image *ReadPNGImage(const ImageIn
   */
   (void) ResetMagickMemory(mng_info,0,sizeof(MngInfo));
   mng_info->image=image;
-  have_mng_structure=MagickTrue;
 
   previous=image;
   image=ReadOnePNGImage(mng_info,image_info,exception);
-  MngInfoFreeStruct(mng_info,&have_mng_structure);
+  mng_info=MngInfoFreeStruct(mng_info);
 
   if (image == (Image *) NULL)
     {
@@ -4498,7 +4493,6 @@ static Image *ReadJNGImage(const ImageIn
     *image;
 
   MagickBooleanType
-    have_mng_structure,
     logging,
     status;
 
@@ -4539,7 +4533,6 @@ static Image *ReadJNGImage(const ImageIn
 
   /* Allocate a MngInfo structure.  */
 
-  have_mng_structure=MagickFalse;
   mng_info=(MngInfo *) AcquireMagickMemory(sizeof(*mng_info));
 
   if (mng_info == (MngInfo *) NULL)
@@ -4548,11 +4541,10 @@ static Image *ReadJNGImage(const ImageIn
   /* Initialize members of the MngInfo structure.  */
 
   (void) ResetMagickMemory(mng_info,0,sizeof(MngInfo));
-  have_mng_structure=MagickTrue;
 
   mng_info->image=image;
   image=ReadOneJNGImage(mng_info,image_info,exception);
-  MngInfoFreeStruct(mng_info,&have_mng_structure);
+  mng_info=MngInfoFreeStruct(mng_info);
 
   if (image == (Image *) NULL)
     {
@@ -4589,8 +4581,7 @@ static Image *ReadMNGImage(const ImageIn
     *image;
 
   MagickBooleanType
-    logging,
-    have_mng_structure;
+    logging;
 
   volatile int
     first_mng_object,
@@ -4697,7 +4688,6 @@ static Image *ReadMNGImage(const ImageIn
 
   first_mng_object=MagickFalse;
   skipping_loop=(-1);
-  have_mng_structure=MagickFalse;
 
   /* Allocate a MngInfo structure.  */
 
@@ -4710,7 +4700,6 @@ static Image *ReadMNGImage(const ImageIn
 
   (void) ResetMagickMemory(mng_info,0,sizeof(MngInfo));
   mng_info->image=image;
-  have_mng_structure=MagickTrue;
 
   if (LocaleCompare(image_info->magick,"MNG") == 0)
     {
@@ -5346,7 +5335,7 @@ static Image *ReadMNGImage(const ImageIn
                     if (GetNextImageInList(image) == (Image *) NULL)
                       {
                         image=DestroyImageList(image);
-                        MngInfoFreeStruct(mng_info,&have_mng_structure);
+                        mng_info=MngInfoFreeStruct(mng_info);
                         return((Image *) NULL);
                       }
 
@@ -5900,7 +5889,7 @@ static Image *ReadMNGImage(const ImageIn
                     if (GetNextImageInList(image) == (Image *) NULL)
                       {
                         image=DestroyImageList(image);
-                        MngInfoFreeStruct(mng_info,&have_mng_structure);
+                        mng_info=MngInfoFreeStruct(mng_info);
                         return((Image *) NULL);
                       }
 
@@ -5953,7 +5942,7 @@ static Image *ReadMNGImage(const ImageIn
               if (GetNextImageInList(image) == (Image *) NULL)
                 {
                   image=DestroyImageList(image);
-                  MngInfoFreeStruct(mng_info,&have_mng_structure);
+                  mng_info=MngInfoFreeStruct(mng_info);
                   return((Image *) NULL);
                 }
 
@@ -6002,7 +5991,7 @@ static Image *ReadMNGImage(const ImageIn
             if (GetNextImageInList(image) == (Image *) NULL)
               {
                 image=DestroyImageList(image);
-                MngInfoFreeStruct(mng_info,&have_mng_structure);
+                mng_info=MngInfoFreeStruct(mng_info);
                 return((Image *) NULL);
               }
 
@@ -6072,7 +6061,7 @@ static Image *ReadMNGImage(const ImageIn
           (void) LogMagickEvent(CoderEvent,GetMagickModule(),
             "exit ReadJNGImage() with error");
 
-        MngInfoFreeStruct(mng_info,&have_mng_structure);
+        mng_info=MngInfoFreeStruct(mng_info);
         return((Image *) NULL);
       }
 
@@ -6080,7 +6069,7 @@ static Image *ReadMNGImage(const ImageIn
       {
         (void) CloseBlob(image);
         image=DestroyImageList(image);
-        MngInfoFreeStruct(mng_info,&have_mng_structure);
+        mng_info=MngInfoFreeStruct(mng_info);
         return((Image *) NULL);
       }
 
@@ -6194,7 +6183,7 @@ static Image *ReadMNGImage(const ImageIn
                 if (GetNextImageInList(image) == (Image *) NULL)
                   {
                     image=DestroyImageList(image);
-                    MngInfoFreeStruct(mng_info,&have_mng_structure);
+                    mng_info=MngInfoFreeStruct(mng_info);
                     return((Image *) NULL);
                   }
 
@@ -6276,7 +6265,7 @@ static Image *ReadMNGImage(const ImageIn
                     (next == (PixelPacket *) NULL))
                   {
                      image=DestroyImageList(image);
-                     MngInfoFreeStruct(mng_info,&have_mng_structure);
+                     mng_info=MngInfoFreeStruct(mng_info);
                      ThrowReaderException(ResourceLimitError,
                        "MemoryAllocationFailed");
                   }
@@ -6742,7 +6731,7 @@ static Image *ReadMNGImage(const ImageIn
           if (GetNextImageInList(image) == (Image *) NULL)
             {
               image=DestroyImageList(image);
-              MngInfoFreeStruct(mng_info,&have_mng_structure);
+              mng_info=MngInfoFreeStruct(mng_info);
 
               if (logging != MagickFalse)
                 (void) LogMagickEvent(CoderEvent,GetMagickModule(),
@@ -6825,7 +6814,7 @@ static Image *ReadMNGImage(const ImageIn
       if (image != (Image *) NULL)
         image=DestroyImageList(image);
 
-      MngInfoFreeStruct(mng_info,&have_mng_structure);
+      mng_info=MngInfoFreeStruct(mng_info);
       return((Image *) NULL);
     }
 
@@ -6959,8 +6948,7 @@ static Image *ReadMNGImage(const ImageIn
    }
 
   image=GetFirstImageInList(image);
-  MngInfoFreeStruct(mng_info,&have_mng_structure);
-  have_mng_structure=MagickFalse;
+  mng_info=MngInfoFreeStruct(mng_info);
 
   if (logging != MagickFalse)
     (void) LogMagickEvent(CoderEvent,GetMagickModule(),"exit ReadMNGImage()");
@@ -10949,7 +10937,6 @@ static MagickBooleanType WritePNGImage(c
   MagickBooleanType
     excluding,
     logging,
-    have_mng_structure,
     status;
 
   MngInfo
@@ -10974,7 +10961,6 @@ static MagickBooleanType WritePNGImage(c
   /*
     Allocate a MngInfo structure.
   */
-  have_mng_structure=MagickFalse;
   mng_info=(MngInfo *) AcquireMagickMemory(sizeof(MngInfo));
 
   if (mng_info == (MngInfo *) NULL)
@@ -10986,7 +10972,6 @@ static MagickBooleanType WritePNGImage(c
   (void) ResetMagickMemory(mng_info,0,sizeof(MngInfo));
   mng_info->image=image;
   mng_info->equal_backgrounds=MagickTrue;
-  have_mng_structure=MagickTrue;
 
   /* See if user has requested a specific PNG subformat */
 
@@ -11630,7 +11615,7 @@ static MagickBooleanType WritePNGImage(c
 
   (void) CloseBlob(image);
 
-  MngInfoFreeStruct(mng_info,&have_mng_structure);
+  mng_info=MngInfoFreeStruct(mng_info);
 
   if (logging != MagickFalse)
     (void) LogMagickEvent(CoderEvent,GetMagickModule(),"exit WritePNGImage()");
@@ -12220,7 +12205,6 @@ static MagickBooleanType WriteOneJNGImag
 static MagickBooleanType WriteJNGImage(const ImageInfo *image_info,Image *image)
 {
   MagickBooleanType
-    have_mng_structure,
     logging,
     status;
 
@@ -12243,7 +12227,6 @@ static MagickBooleanType WriteJNGImage(c
   /*
     Allocate a MngInfo structure.
   */
-  have_mng_structure=MagickFalse;
   mng_info=(MngInfo *) AcquireMagickMemory(sizeof(MngInfo));
   if (mng_info == (MngInfo *) NULL)
     ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
@@ -12252,15 +12235,14 @@ static MagickBooleanType WriteJNGImage(c
   */
   (void) ResetMagickMemory(mng_info,0,sizeof(MngInfo));
   mng_info->image=image;
-  have_mng_structure=MagickTrue;
 
   (void) WriteBlob(image,8,(const unsigned char *) "\213JNG\r\n\032\n");
 
   status=WriteOneJNGImage(mng_info,image_info,image);
+  mng_info=MngInfoFreeStruct(mng_info);
   (void) CloseBlob(image);
 
   (void) CatchImageException(image);
-  MngInfoFreeStruct(mng_info,&have_mng_structure);
   if (logging != MagickFalse)
     (void) LogMagickEvent(CoderEvent,GetMagickModule(),"exit WriteJNGImage()");
   return(status);
@@ -12278,7 +12260,6 @@ static MagickBooleanType WriteMNGImage(c
     *next_image;
 
   MagickBooleanType
-    have_mng_structure,
     status;
 
   volatile MagickBooleanType
@@ -12340,7 +12321,6 @@ static MagickBooleanType WriteMNGImage(c
   /*
     Allocate a MngInfo structure.
   */
-  have_mng_structure=MagickFalse;
   mng_info=(MngInfo *) AcquireMagickMemory(sizeof(MngInfo));
   if (mng_info == (MngInfo *) NULL)
     ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
@@ -12349,7 +12329,6 @@ static MagickBooleanType WriteMNGImage(c
   */
   (void) ResetMagickMemory(mng_info,0,sizeof(MngInfo));
   mng_info->image=image;
-  have_mng_structure=MagickTrue;
   write_mng=LocaleCompare(image_info->magick,"MNG") == 0;
 
   /*
@@ -13107,7 +13086,7 @@ static MagickBooleanType WriteMNGImage(c
 
     if (status == MagickFalse)
       {
-        MngInfoFreeStruct(mng_info,&have_mng_structure);
+        mng_info=MngInfoFreeStruct(mng_info);
         (void) CloseBlob(image);
         return(MagickFalse);
       }
@@ -13140,7 +13119,7 @@ static MagickBooleanType WriteMNGImage(c
     Relinquish resources.
   */
   (void) CloseBlob(image);
-  MngInfoFreeStruct(mng_info,&have_mng_structure);
+  mng_info=MngInfoFreeStruct(mng_info);
 
   if (logging != MagickFalse)
     (void) LogMagickEvent(CoderEvent,GetMagickModule(),"exit WriteMNGImage()");
