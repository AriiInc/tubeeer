Backport of:

From 05726c66756346f671f335eb533abd167e557352 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Thu, 27 Apr 2017 12:30:48 +0200
Subject: [PATCH] [3/3] CVE-2017-8350 Fixed various leaks in ReadOneJNGImage
 reported in #447

origin: https://github.com/ImageMagick/ImageMagick/commit/a353ee3914d7f0a83078f5ef84a7766587c98121
bug: https://github.com/ImageMagick/ImageMagick/issues/447
bug-debian: https://bugs.debian.org/862587
---
 coders/png.c | 24 ++++++++++++++++++++----
 1 file changed, 20 insertions(+), 4 deletions(-)

Index: imagemagick-6.7.7.10/coders/png.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/png.c	2017-05-26 08:57:46.902307989 -0400
+++ imagemagick-6.7.7.10/coders/png.c	2017-05-26 08:58:17.358695914 -0400
@@ -3866,7 +3866,7 @@ static Image *ReadOneJNGImage(MngInfo *m
       AcquireNextImage(image_info,image);
 
       if (GetNextImageInList(image) == (Image *) NULL)
-        return((Image *) NULL);
+        return(DestroyImageList(image));
 
       image=SyncNextImageInList(image);
     }
@@ -4038,7 +4038,7 @@ static Image *ReadOneJNGImage(MngInfo *m
           exception);
 
         if (status == MagickFalse)
-          return((Image *) NULL);
+          return(DestroyImageList(image));
 
         if ((image_info->ping == MagickFalse) && (jng_color_type >= 12))
           {
@@ -4067,7 +4067,7 @@ static Image *ReadOneJNGImage(MngInfo *m
               exception);
 
             if (status == MagickFalse)
-              return((Image *) NULL);
+              return(DestroyImageList(image));
 
             if (jng_alpha_compression_method == 0)
               {
@@ -4321,6 +4321,19 @@ static Image *ReadOneJNGImage(MngInfo *m
        o destroy the secondary image.
   */
 
+  if (color_image_info == (ImageInfo *) NULL)
+    {
+      assert(color_image == (Image *) NULL);
+      assert(alpha_image == (Image *) NULL);
+      return(DestroyImageList(image));
+    }
+
+  if (color_image == (Image *) NULL)
+    {
+      assert(alpha_image == (Image *) NULL);
+      return(DestroyImageList(image));
+    }
+
   (void) CloseBlob(color_image);
 
   if (logging != MagickFalse)
@@ -4341,7 +4354,7 @@ static Image *ReadOneJNGImage(MngInfo *m
   color_image_info=DestroyImageInfo(color_image_info);
 
   if (jng_image == (Image *) NULL)
-    return((Image *) NULL);
+    return(DestroyImageList(image));
 
   if (logging != MagickFalse)
     (void) LogMagickEvent(CoderEvent,GetMagickModule(),
@@ -4449,6 +4462,9 @@ static Image *ReadOneJNGImage(MngInfo *m
   status=SetImageProgress(image,LoadImagesTag,2*TellBlob(image),
     2*GetBlobSize(image));
 
+  if (status == MagickFalse)
+    return(DestroyImageList(image));
+
   if (logging != MagickFalse)
     (void) LogMagickEvent(CoderEvent,GetMagickModule(),
       "  exit ReadOneJNGImage()");
