From aae2beea0537059e5b3271cf2e2ce33520fa6281 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Wed, 26 Apr 2017 15:25:14 -0400
Subject: [PATCH] CVE-2017-8349

The ReadSFWImage function in sfw.c allows attackers to cause a denial of service (memory leak) via a crafted file.

bug: https://github.com/ImageMagick/ImageMagick/issues/443
bug-debian: https://bugs.debian.org/862579
origin: https://github.com/ImageMagick/ImageMagick/commit/bfda0b62fb5de2d7d2c229c432e1650f7d2973bf
---
 coders/sfw.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

Index: imagemagick-6.7.7.10/coders/sfw.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/sfw.c	2017-05-26 09:16:49.236857990 -0400
+++ imagemagick-6.7.7.10/coders/sfw.c	2017-05-26 09:16:49.232857939 -0400
@@ -260,7 +260,10 @@ static Image *ReadSFWImage(const ImageIn
   count=ReadBlob(image,(size_t) GetBlobSize(image),buffer);
   if ((count != (ssize_t) GetBlobSize(image)) ||
       (LocaleNCompare((char *) buffer,"SFW",3) != 0))
-    ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+    {
+      buffer=(unsigned char *) RelinquishMagickMemory(buffer);
+      ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+    }
   (void) CloseBlob(image);
   /*
     Find the start of the JFIF data
