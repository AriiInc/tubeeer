From 4dc7e36f34bfd7fa55c350a48571aaf1c8191b74 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Sun, 7 May 2017 11:13:07 +0200
Subject: [PATCH] CVE-2017-8830

The ReadBMPImage function in bmp.c:1379 allows attackers to cause a denial of service (memory leak) via a crafted file.

Replace image in list to fix issue reported in #467.

(cherry picked from commit ff2431d8f17d4a7c906438042a649b04aec93558)

bug: https://github.com/ImageMagick/ImageMagick/issues/467
bug-debian: https://bugs.debian.org/862637
origin: https://github.com/ImageMagick/ImageMagick/commit/ff2431d8f17d4a7c906438042a649b04aec93558
---
 coders/bmp.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: imagemagick-6.7.7.10/coders/bmp.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/bmp.c	2017-05-26 09:17:46.445586661 -0400
+++ imagemagick-6.7.7.10/coders/bmp.c	2017-05-26 09:17:46.445586661 -0400
@@ -1327,7 +1327,7 @@ static Image *ReadBMPImage(const ImageIn
         if (flipped_image != (Image *) NULL)
           {
             DuplicateBlob(flipped_image,image);
-            image=DestroyImage(image);
+            ReplaceImageInList(&image, flipped_image);
             image=flipped_image;
           }
       }
