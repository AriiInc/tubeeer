From 0d0707a60be40e2dfb728d6574831fd94dd485c1 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Wed, 31 May 2017 06:20:59 -0400
Subject: [PATCH] CVE-2017-9144 fix incomplete patch

a crafted RLE image can trigger a crash because of incorrect EOF handling in coders/rle.c

bug: https://github.com/ImageMagick/ImageMagick/issues/502
origin: https://github.com/ImageMagick/ImageMagick/commit/7f1f01b695e869c410ee10e2176f8fd764f09373
bug-debian: https://bugs.debian.org/863126

(cherry picked from commit 7f1f01b695e869c410ee10e2176f8fd764f09373)
---
 coders/rle.c | 18 +++++++++---------
 1 file changed, 9 insertions(+), 9 deletions(-)

Index: imagemagick-6.7.7.10/coders/rle.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/rle.c	2017-07-21 10:02:12.805296975 -0400
+++ imagemagick-6.7.7.10/coders/rle.c	2017-07-21 10:02:12.805296975 -0400
@@ -392,12 +392,12 @@ static Image *ReadRLEImage(const ImageIn
         case SkipLinesOp:
         {
           operand=ReadBlobByte(image);
-          if (opcode == EOF)
+          if (operand == EOF)
             ThrowRLEException(CorruptImageError,"UnexpectedEndOfFile");
           if (opcode & 0x40)
             {
               operand=ReadBlobLSBShort(image);
-              if (opcode == EOF)
+              if (operand == EOF)
                 ThrowRLEException(CorruptImageError,"UnexpectedEndOfFile");
             }
           x=0;
@@ -407,7 +407,7 @@ static Image *ReadRLEImage(const ImageIn
         case SetColorOp:
         {
           operand=ReadBlobByte(image);
-          if (opcode == EOF)
+          if (operand == EOF)
             ThrowRLEException(CorruptImageError,"UnexpectedEndOfFile");
           plane=(unsigned char) operand;
           if (plane == 255)
@@ -418,12 +418,12 @@ static Image *ReadRLEImage(const ImageIn
         case SkipPixelsOp:
         {
           operand=ReadBlobByte(image);
-          if (opcode == EOF)
+          if (operand == EOF)
             ThrowRLEException(CorruptImageError,"UnexpectedEndOfFile");
           if (opcode & 0x40)
             {
               operand=ReadBlobLSBShort(image);
-              if (opcode == EOF)
+              if (operand == EOF)
                 ThrowRLEException(CorruptImageError,"UnexpectedEndOfFile");
             }
           x+=operand;
@@ -432,12 +432,12 @@ static Image *ReadRLEImage(const ImageIn
         case ByteDataOp:
         {
           operand=ReadBlobByte(image);
-          if (opcode == EOF)
+          if (operand == EOF)
             ThrowRLEException(CorruptImageError,"UnexpectedEndOfFile");
           if (opcode & 0x40)
             {
               operand=ReadBlobLSBShort(image);
-              if (opcode == EOF)
+              if (operand == EOF)
                 ThrowRLEException(CorruptImageError,"UnexpectedEndOfFile");
             }
           offset=(ssize_t) (((image->rows-y-1)*image->columns*number_planes)+x*
@@ -467,12 +467,12 @@ static Image *ReadRLEImage(const ImageIn
         case RunDataOp:
         {
           operand=ReadBlobByte(image);
-          if (opcode == EOF)
+          if (operand == EOF)
             ThrowRLEException(CorruptImageError,"UnexpectedEndOfFile");
           if (opcode & 0x40)
             {
               operand=ReadBlobLSBShort(image);
-              if (opcode == EOF)
+              if (operand == EOF)
                 ThrowRLEException(CorruptImageError,"UnexpectedEndOfFile");
             }
           pixel=(unsigned char) ReadBlobByte(image);
