From 731cab6d425cace710dbf15cd1efc656d9ea07f4 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Mon, 15 May 2017 21:24:24 +0200
Subject: [PATCH] [1/3] CVE-2017-9501 Fixed incorrect call to DestroyImage
 reported in #491.

an assertion failure was found in the function LockSemaphoreInfo, which allows attackers to cause a denial of service via a crafted file.

bug: https://github.com/ImageMagick/ImageMagick/issues/491
bug-debian: https://bugs.debian.org/867721
origin:  https://github.com/ImageMagick/ImageMagick/commit/01843366d6a7b96e22ad7bb67f3df7d9fd4d5d74

(cherry picked from commit 01843366d6a7b96e22ad7bb67f3df7d9fd4d5d74)
---
 magick/image.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: imagemagick-6.7.7.10/magick/image.c
===================================================================
--- imagemagick-6.7.7.10.orig/magick/image.c	2017-07-21 10:01:47.561295798 -0400
+++ imagemagick-6.7.7.10/magick/image.c	2017-07-21 10:01:47.561295798 -0400
@@ -822,7 +822,7 @@ MagickExport Image *CloneImage(const Ima
         sizeof(*clone_image->colormap));
       if (clone_image->colormap == (PixelPacket *) NULL)
         {
-          clone_image=DestroyImage(clone_image);
+          image=(Image *) RelinquishMagickMemory(image);
           ThrowImageException(ResourceLimitError,"MemoryAllocationFailed");
         }
       (void) CopyMagickMemory(clone_image->colormap,image->colormap,length*
