From 6afa442af8a86da98dc93a332ff20e2a250487c3 Mon Sep 17 00:00:00 2001
From: cristy <cristy@aa41f4f7-0bf4-0310-aa73-e5a19afd5a74>
Date: Sun, 16 Feb 2014 21:48:05 +0000
Subject: [PATCH] Prevent buffer overflow in messaging system (CVE: 2014-1947)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Bug-redhat: https://bugzilla.redhat.com/show_bug.cgi?id=1067276
Bug-debian: http://bugs.debian.org/740250
git-svn-id: https://subversion.imagemagick.org/subversion/ImageMagick/branches/ImageMagick-6@14900 aa41f4f7-0bf4-0310-aa73-e5a19afd5a74
Signed-off-by: Bastien ROUCARIÃˆS <roucaries.bastien@gmail.com>
---
 magick/locale.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/magick/locale.c b/magick/locale.c
index fbe902d..ad998b9 100644
--- a/magick/locale.c
+++ b/magick/locale.c
@@ -1061,6 +1061,13 @@ static void LocaleFatalErrorHandler(
   exit(1);
 }
 
+static inline size_t MagickMin(const unsigned int x,
+  const unsigned int y)
+{
+  if (x < y)
+    return(x);
+  return(y);
+}
 
 static MagickBooleanType LoadLocaleList(const char *xml,const char *filename,
   const char *locale,const size_t depth,ExceptionInfo *exception)
@@ -1240,7 +1247,8 @@ static MagickBooleanType LoadLocaleList(const char *xml,const char *filename,
         q--;
         while ((isspace((int) ((unsigned char) *q)) != 0) && (q > p))
           q--;
-        (void) CopyMagickString(message,p,(size_t) (q-p+2));
+        (void) CopyMagickString(message,p,MagickMin(q-p+2,sizeof(message)-
+          strlen(message)));
         locale_info=(LocaleInfo *) AcquireMagickMemory(sizeof(*locale_info));
         if (locale_info == (LocaleInfo *) NULL)
           ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
-- 
1.8.3.2

