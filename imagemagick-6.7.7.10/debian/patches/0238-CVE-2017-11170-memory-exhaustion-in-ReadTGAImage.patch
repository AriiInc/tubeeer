From 4be724a12dade650c2b18c65d3fe0ace61857b58 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sat, 6 May 2017 13:31:00 -0400
Subject: [PATCH] CVE-2017-11170 memory exhaustion in ReadTGAImage

When identify VST file, imagemagick will allocate memory to store data in function ReadTGAImage in coders\tga.c
using tga_info.bits_per_pixel field diretly from VST file without checking in tga.c
By review the founction code, tga_info.bits_per_pixel max valid value is 32.
On 32bit os, size_t one will be 32bit, so image->colors can be overflow to 0.
On 64bit os, size_t one will be 64bit, so image->colors can be large as 0x100000000(64GB).

Original patch was edited to remove magick/image.c modifications that lead to compile error
(reverted in 87664f06ef49a1635cf83ab19981800fc655b746)

bug: CVE-2017-11170 memory exhaustion in ReadTGAImage
origin: https://github.com/ImageMagick/ImageMagick/commit/ea03f17c96467d037d1a21fba1b0b35613658d5b
bug-debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=868184
---
 coders/tga.c | 2 ++
 1 file changed, 2 insertions(+)

Index: imagemagick-6.7.7.10/coders/tga.c
===================================================================
--- imagemagick-6.7.7.10.orig/coders/tga.c	2017-07-21 10:01:43.285295598 -0400
+++ imagemagick-6.7.7.10/coders/tga.c	2017-07-21 10:01:43.281295598 -0400
@@ -261,6 +261,8 @@ static Image *ReadTGAImage(const ImageIn
 
           one=1;
           image->colors=one << tga_info.bits_per_pixel;
+          if (image->colors > ((~0UL)/sizeof(*image->colormap)))
+            ThrowReaderException(CorruptImageError,"ImproperImageHeader");
           if (AcquireImageColormap(image,image->colors) == MagickFalse)
             ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
         }
