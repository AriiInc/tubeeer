From a74ca4b9159ff7a1ec5b4b63bdc897e96c75dc62 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Mon, 15 May 2017 19:07:56 -0400
Subject: [PATCH] [2/3] CVE-2017-9501 Avoid an off-by one error

an assertion failure was found in the function LockSemaphoreInfo, which allows attackers to cause a denial of service via a crafted file.

bug: https://github.com/ImageMagick/ImageMagick/issues/491
bug-debian: https://bugs.debian.org/867721
origin:  https://github.com/ImageMagick/ImageMagick/commit/b21f81ab5e31f5f0bbf177663e2c3d888135ab9b

(cherry picked from commit b21f81ab5e31f5f0bbf177663e2c3d888135ab9b)
---
 magick/image.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: imagemagick-6.7.7.10/magick/image.c
===================================================================
--- imagemagick-6.7.7.10.orig/magick/image.c	2017-07-21 10:01:50.477295934 -0400
+++ imagemagick-6.7.7.10/magick/image.c	2017-07-21 10:01:50.477295934 -0400
@@ -818,7 +818,7 @@ MagickExport Image *CloneImage(const Ima
       */
       clone_image->colors=image->colors;
       length=(size_t) image->colors;
-      clone_image->colormap=(PixelPacket *) AcquireQuantumMemory(length,
+      clone_image->colormap=(PixelPacket *) AcquireQuantumMemory(length+1,
         sizeof(*clone_image->colormap));
       if (clone_image->colormap == (PixelPacket *) NULL)
         {
