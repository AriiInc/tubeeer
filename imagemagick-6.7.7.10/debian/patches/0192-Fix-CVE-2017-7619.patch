Backport of:

From 28a7b59daf731eb8d07ffac8aa99226a5918e655 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Fri, 3 Mar 2017 18:42:52 -0500
Subject: [PATCH] Fix CVE-2017-7619

In ImageMagick 7.0.4-9, an infinite loop can occur because of a floating-point rounding error in some of the color algorithms.

This affects ModulateHSL, ModulateHCL, ModulateHCLp, ModulateHSB, ModulateHSI, ModulateHSV, ModulateHWB, ModulateLCHab, and ModulateLCHuv.

Forwarded: Yes, https://www.imagemagick.org/discourse-server/viewtopic.php?f=3&t=31506
origin:  http://git.imagemagick.org/repos/ImageMagick/commit/63757068c803f692bd70304b06ce3406e0b67c7f
bug:  https://www.imagemagick.org/discourse-server/viewtopic.php?f=3&t=31506
bug-debian: https://bugs.debian.org/859769
---
 magick/enhance.c | 54 +++++++++---------------------------------------------
 1 file changed, 9 insertions(+), 45 deletions(-)

Index: imagemagick-6.7.7.10/magick/enhance.c
===================================================================
--- imagemagick-6.7.7.10.orig/magick/enhance.c	2017-05-26 08:36:22.173944306 -0400
+++ imagemagick-6.7.7.10/magick/enhance.c	2017-05-26 08:38:08.563299396 -0400
@@ -3177,11 +3177,7 @@ static void ModulateHSB(const double per
   assert(green != (Quantum *) NULL);
   assert(blue != (Quantum *) NULL);
   ConvertRGBToHSB(*red,*green,*blue,&hue,&saturation,&brightness);
-  hue+=0.5*(0.01*percent_hue-1.0);
-  while (hue < 0.0)
-    hue+=1.0;
-  while (hue > 1.0)
-    hue-=1.0;
+  hue+=fmod((percent_hue-100.0),200.0)/200.0;
   saturation*=0.01*percent_saturation;
   brightness*=0.01*percent_brightness;
   ConvertHSBToRGB(hue,saturation,brightness,red,green,blue);
@@ -3203,11 +3199,7 @@ static void ModulateHSL(const double per
   assert(green != (Quantum *) NULL);
   assert(blue != (Quantum *) NULL);
   ConvertRGBToHSL(*red,*green,*blue,&hue,&saturation,&lightness);
-  hue+=0.5*(0.01*percent_hue-1.0);
-  while (hue < 0.0)
-    hue+=1.0;
-  while (hue > 1.0)
-    hue-=1.0;
+  hue+=fmod((percent_hue-100.0),200.0)/200.0;
   saturation*=0.01*percent_saturation;
   lightness*=0.01*percent_lightness;
   ConvertHSLToRGB(hue,saturation,lightness,red,green,blue);
@@ -3227,11 +3219,7 @@ static void ModulateHWB(const double per
   assert(green != (Quantum *) NULL);
   assert(blue != (Quantum *) NULL);
   ConvertRGBToHWB(*red,*green,*blue,&hue,&whiteness,&blackness);
-  hue+=0.5*(0.01*percent_hue-1.0);
-  while (hue < 0.0)
-    hue+=1.0;
-  while (hue > 1.0)
-    hue-=1.0;
+  hue+=fmod((percent_hue-100.0),200.0)/200.0;
   blackness*=0.01*percent_blackness;
   whiteness*=0.01*percent_whiteness;
   ConvertHWBToRGB(hue,whiteness,blackness,red,green,blue);
